name: Build iOS for Simulator (No Signing)

on:
  push:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: macos-latest

    steps:
    # 1. Checkout the repo
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. Setup Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18

    # 3. Install npm dependencies
    - name: Install Dependencies
      run: npm install

    # 4. Ensure Capacitor CLI has execute permissions and sync iOS
    - name: Sync Capacitor
      run: |
        chmod +x ./node_modules/.bin/cap
        npx cap sync ios

    # 5. Update CocoaPods dependencies
    - name: Update CocoaPods
      run: |
        cd ios/App
        pod install --repo-update

    # 6. Build for Simulator (No signing required)
    - name: Build for Simulator (No Signing Required)
      run: |
        cd ios/App
        xcodebuild \
          -workspace App.xcworkspace \
          -scheme App \
          -configuration Release \
          -destination 'platform=iOS Simulator,name=iPhone 14' \
          -derivedDataPath build \
          CODE_SIGNING_ALLOWED=NO

    # 7. Zip the built app
    - name: Zip the Build
      run: |
        cd ios/App/build/Build/Products/Release-iphonesimulator
        zip -r App.zip App.app

    # 8. Upload the zipped artifact
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-simulator
        path: ios/App/build/Build/Products/Release-iphonesimulator/App.zip
