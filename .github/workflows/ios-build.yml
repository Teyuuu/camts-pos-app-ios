name: Build iOS for Simulator (No Signing)

on:
  push:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: macos-latest

    steps:
    # 1. Checkout the repo
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. Setup Node.js (Capacitor >=5 requires Node >=20)
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 20

    # 3. Cache npm dependencies
    - name: Cache npm
      uses: actions/cache@v3
      with:
        path: ~/.npm
        key: npm-cache-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          npm-cache-

    # 4. Install npm dependencies
    - name: Install Dependencies
      run: npm install

    # 5. Ensure Capacitor CLI is executable and sync iOS
    - name: Sync Capacitor
      run: |
        chmod +x ./node_modules/.bin/cap
        npx cap sync ios

    # 6. Cache CocoaPods
    - name: Cache CocoaPods
      uses: actions/cache@v3
      with:
        path: ios/App/Pods
        key: pod-cache-${{ hashFiles('ios/App/Podfile.lock') }}
        restore-keys: |
          pod-cache-

    # 7. Update CocoaPods dependencies
    - name: Update CocoaPods
      run: |
        cd ios/App
        pod install --repo-update

    # 8. Build for Simulator (No signing required) using available simulator
    - name: Build for Simulator (No Signing Required)
      run: |
        cd ios/App
        xcodebuild \
          -workspace App.xcworkspace \
          -scheme App \
          -configuration Release \
          -destination 'platform=iOS Simulator,name=iPhone 16,OS=18.6' \
          -derivedDataPath build \
          CODE_SIGNING_ALLOWED=NO

    # 9. Zip the built app
    - name: Zip the Build
      run: |
        cd ios/App/build/Build/Products/Release-iphonesimulator
        zip -r App.zip App.app

    # 10. Upload the zipped artifact
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-simulator
        path: ios/App/build/Build/Products/Release-iphonesimulator/App.zip
